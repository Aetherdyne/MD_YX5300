<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MD_YX5300 Library: Message Flow Management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="MajicDesigns_Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MD_YX5300 Library
   &#160;<span id="projectnumber">1.2</span>
   </div>
   <div id="projectbrief">Library for YX5300 MP3 player IC</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_software.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Message Flow Management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="YX5300_Board_Layout.jpg" alt="YX5300_Board_Layout.jpg"/>
<div class="caption">
YX5300 Board Layout</div></div>
<h2>Communications Format </h2>
<p>The MP3 module communicates using asynchronous RS232 serial communication at 9600 bps, 8 data bits, No parity, 1 stop bit, no flow control.</p>
<p>Flow control is implemented using a serial RQST/RESP protocol based on data packets with the following byte sequence:</p>
<div class="image">
<img src="YX5300_Packet_Structure.png" alt="YX5300_Packet_Structure.png"/>
<div class="caption">
YX5300 Packet Structure</div></div>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Byte  </th><th class="markdownTableHeadRight">Value  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Start  </td><td class="markdownTableBodyRight">0x7e  </td><td class="markdownTableBodyLeft">The start of each packet, used for synchronization.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Version  </td><td class="markdownTableBodyRight">0xff  </td><td class="markdownTableBodyLeft">Always the same value in this implementation.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Length  </td><td class="markdownTableBodyRight">0x06  </td><td class="markdownTableBodyLeft">Number of bytes between Start and Chk.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Cmd  </td><td class="markdownTableBodyRight">0x??  </td><td class="markdownTableBodyLeft">Command code for required action.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Fback  </td><td class="markdownTableBodyRight">0x01  </td><td class="markdownTableBodyLeft">Set to 1 for protocol feedback, 0 for none.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">DataHi  </td><td class="markdownTableBodyRight">0x??  </td><td class="markdownTableBodyLeft" rowspan="2">Length-4 data bytes = 2 in this implementation.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">DataLo  </td><td class="markdownTableBodyRight">0x??   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">ChkHi  </td><td class="markdownTableBodyRight">0x??  </td><td class="markdownTableBodyLeft" rowspan="2">Optional checksum for bytes between Start and Chk.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ChkLo  </td><td class="markdownTableBodyRight">0x??   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">End  </td><td class="markdownTableBodyRight">0xef  </td><td class="markdownTableBodyLeft">The end of each packet.   </td></tr>
</table>
<p>The checksum is optional in the protocol packet. The library will use the checksum field if the C++ macro define USE_CHECKSUM is set to 1 in the header file.</p>
<h2>Message Flow </h2>
<p>The message flow between the device and MCU can be displayed on the Serial Monitor by the library when the C++ macro define LIBDEBUG is set to 1 in the main code file.</p>
<p>Message are of 2 basic types.</p>
<ul>
<li>The first type is a simple message to set or cause an action in the Device. In this case the messages are exchanged as one message/acknowledge pair.</li>
</ul>
<div class="mscgraph">
<img src="msc_inline_mscgraph_1.png" alt="msc_inline_mscgraph_1" border="0"/>
</div>
<ul>
<li>The second type is a message that is requesting information from the YX5300. In this case the simple message flow is followed a short time later by another message from the device containing the requested data.</li>
</ul>
<div class="mscgraph">
<img src="msc_inline_mscgraph_2.png" alt="msc_inline_mscgraph_2" border="0"/>
</div>
<h2>Sending and Receiving Serial Messages </h2>
<p>This library manages the serial interface to the TX5300 by taking care of sending and receiving the serial messages. The MP3 Player responds to command requests but it also sends unsolicited messages when certain events occur (eg, TF card removed or inserted). These unsolicited messages may be important to the application so the library implements mechanisms that allow the application to process the relevant notification data by placing it in a cbData structure.</p>
<p>How the cbData structure is received by the application is flexible and depends on the setSynchronous() setting and whether a callback is defined. This is summarized in the table below and explained in the text that follows.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight"></th><th class="markdownTableHeadLeft">Callback  </th><th class="markdownTableHeadLeft">Polled   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight" rowspan="2">Sync  </td><td class="markdownTableBodyLeft"><em>unsol</em>: callback  </td><td class="markdownTableBodyLeft"><em>unsol</em>: check()   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><em>resp</em>: ret status  </td><td class="markdownTableBodyLeft"><em>resp</em>: ret status   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight" rowspan="2">Async  </td><td class="markdownTableBodyLeft"><em>unsol</em>: callback  </td><td class="markdownTableBodyLeft"><em>unsol</em>: check()   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><em>resp</em>: callback  </td><td class="markdownTableBodyLeft"><em>resp</em>: check()   </td></tr>
</table>
<p>The first choice is whether to process the message in line with the calling sequence (synchronous) or separately (asynchronously):</p><ul>
<li><b>Synchronous</b>: The command message is sent and the code waits for the response before returning to the calling application. This is relatively inefficient of CPU time as it involves a busy wait, but is easy to implement in code flow and is good for non-critical applications.</li>
</ul>
<div class="mscgraph">
<img src="msc_inline_mscgraph_3.png" alt="msc_inline_mscgraph_3" border="0"/>
</div>
<ul>
<li><b>Asynchronous</b>: The command message is sent and the library immediately returns. The response message is processed as it returns and the calling application can continue to run while this happens. Once the response is received, the calling can be notified through a callback or polled status (see below).</li>
</ul>
<div class="mscgraph">
<img src="msc_inline_mscgraph_4.png" alt="msc_inline_mscgraph_4" border="0"/>
</div>
<p>Independently of the sync/async mode, the application can choose to be informed received messages are ready to process either by:</p><ul>
<li><b>Polling</b>: The return status of the check() method is used as the signal that an unsolicited message has been received. In synchronous mode the return code for the method invoked will be the status of check() for that request.</li>
</ul>
<p><em>Synchronous polled return flow</em> </p><div class="mscgraph">
<img src="msc_inline_mscgraph_5.png" alt="msc_inline_mscgraph_5" border="0"/>
</div>
<p><em>Asynchronous polled return flow</em> </p><div class="mscgraph">
<img src="msc_inline_mscgraph_6.png" alt="msc_inline_mscgraph_6" border="0"/>
</div>
<ul>
<li><b>Callback</b>: If a callback function is defined (see setCallback()), every unsolicited message received will be processed through the callback mechanism. In Synchronous mode, both the callback and the return code for the method invoked will signal receipt of the same message, so the application code should guard against processing the message twice.</li>
</ul>
<p><em>Synchronous callback return flow</em> </p><div class="mscgraph">
<img src="msc_inline_mscgraph_7.png" alt="msc_inline_mscgraph_7" border="0"/>
</div>
<p><em>Asynchronous callback return flow</em> </p><div class="mscgraph">
<img src="msc_inline_mscgraph_8.png" alt="msc_inline_mscgraph_8" border="0"/>
</div>
 </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Arduino Serial MP3 Player</a></li>
    <li class="footer">Generated on Sun Apr 14 2019 11:49:36 for MD_YX5300 Library by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
